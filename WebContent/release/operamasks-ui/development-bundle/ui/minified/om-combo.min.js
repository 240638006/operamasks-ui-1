(function(b){var a="_value";if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e){var c=this.length;for(var d=0;d<c;d++){if(this[d]===e){return d}}return -1}}b.widget("om.omCombo",{options:{optionField:"text",valueField:"value",width:"auto",disabled:false,readOnly:false,editable:true,lazyLoad:false,listMaxHeight:300,listAutoWidth:false,autoFilter:true,filterStrategy:"first",filterDelay:500},_init:function(){var c=this.options,f=this.element,e=c.dataSource;if(c.width!="auto"){var d=f.parent().width(c.width);f.width(d.innerWidth()-f.next().outerWidth()-f.outerWidth()+f.width())}c.disabled?f.attr("disabled",true):f.removeAttr("disabled");(c.readOnly||!c.editable)?f.attr("readonly","readOnly"):f.removeAttr("readonly");if(!c.lazyLoad){this._toggleLoading(f,"add");if(e&&typeof e=="string"){this._ajaxLoad(f,e)}else{if(e&&typeof e=="object"){this._loadData(f,e);this._toggleLoading(f,"remove")}else{this.dataHasLoaded=true;this._toggleLoading(f,"remove")}}}else{this.dataHasLoaded=false}var g=c.disabled||c.readOnly;if(g){b.data(f,"expandTrigger").addClass("om-state-disabled")}else{this._bindEvent()}},_create:function(){var d=this.options;if(!d.inputField){d.inputField=d.optionField}if(typeof d.value!=="undefined"){d.lazyLoad=false}var g=this.element;this._refeshEmptyText(d.emptyText,g);g.attr("autocomplete","off");var f=b('<span class="om-combo om-widget om-state-default"></span>').insertAfter(g).wrapInner(g);var c=b('<span class="om-combo-trigger om-icon om-icon-carat-1-s"></span>').appendTo(f);var e=b(b('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css("position","absolute").appendTo(document.body).children()[0]).hide();b.data(g,"combo",this);b.data(g,"expandTrigger",c);b.data(g,"dropList",e)},setData:function(e){var c=this;var d=c.element;c.options.value="";d.val("");c._toggleLoading(d,"add");if(typeof e==="string"){c._ajaxLoad(d,e)}else{c._loadData(d,e);c._toggleLoading(d,"remove")}},getData:function(){var c=this.options.dataSource;return(typeof c=="object")?c:null},value:function(c){if(typeof c==="undefined"){var d=b(this.element).attr(a);return d?d:""}else{this._setValue(this.element,c);return this}},disable:function(){var c=this.element;c.attr("disabled",true).unbind();this.options.disabled=true;b.data(c,"expandTrigger").addClass("om-state-disabled").unbind()},enable:function(){var c=this.element;c.removeAttr("disabled").unbind();this.options.disabled=false;b.data(c,"expandTrigger").removeClass("om-state-disabled").unbind();this._bindEvent()},_bindEvent:function(){var e=this;var g=this.options;var d=this.element;var i=d.parent("span");var h=b.data(d,"dropList");var j=b.data(d,"expandTrigger");var c=g.emptyText;var f=false;i.mouseenter(function(){if(!g.disabled){i.addClass("om-state-hover")}}).mouseleave(function(){i.removeClass("om-state-hover")});d.focus(function(){if(f){return}f=true;b(".om-droplist").hide();i.addClass("om-state-focus");e._refeshEmptyText(c,d);if(!e.dataHasLoaded){if(!j.hasClass("om-loading")){e._toggleLoading(d,"add");if(typeof(g.dataSource)=="object"){e._loadData(d,g.dataSource);e._toggleLoading(d,"remove")}else{if(typeof(g.dataSource)=="string"){e._ajaxLoad(d,g.dataSource)}else{e.dataHasLoaded=true;e._toggleLoading(d,"remove")}}}}if(!g.disabled&&!g.readOnly){e._showDropList(d)}}).blur(function(n){f=false;i.removeClass("om-state-focus");d.removeClass("om-combo-focus");if(!g.disabled&&!g.readOnly){if(e.hasManualInput){e.hasManualInput=false;var o=d.val();if(o!==""){var p=b.data(d,"allInputText");var k=b.data(d,"allValues");var l=p.indexOf(o);if(l>-1){e._setValue(d,k[l])}else{var m=d.attr(a);l=k.indexOf(m);if(l>-1){d.val(p[l])}else{d.val("")}}}}e._refeshEmptyText(c,d)}}).keyup(function(l){var k=l.keyCode;switch(k){case 40:e._selectNext();break;case 38:e._selectPrev();break;case 13:e._backfill();break;case 27:h.hide();break;case 9:break;default:e.hasManualInput=true;if(!g.disabled&&!g.readOnly&&g.editable&&g.autoFilter){if(window._omcomboFilterTimer){clearTimeout(window._omcomboFilterTimer)}window._omcomboFilterTimer=setTimeout(function(){if(b(document).attr("activeElement").id==d.attr("id")){h.show()}e._doFilter(d)},g.filterDelay)}}});i.mousedown(function(k){k.stopPropagation()});h.mousedown(function(k){k.stopPropagation()});j.click(function(){!j.hasClass("om-loading")&&d.focus()}).mousedown(function(){!j.hasClass("om-loading")&&i.addClass("om-state-active")}).mouseup(function(){!j.hasClass("om-loading")&&i.removeClass("om-state-active")});b(document).bind("mousedown.omCombo",function(){h.hide()})},_showDropList:function(k){var h=this._getAllOptionsBeforeFiltered(k).removeClass("om-helper-hidden om-state-hover");if(h.size()<=0){return}var m=this.options;var c=b.data(k,"dropList").scrollTop(0).css("height","auto");if(m.listMaxHeight!="auto"&&c.height()>m.listMaxHeight){c.height(m.listMaxHeight).css("overflow-y","auto")}var l;var e=k.attr(a);if(e!==""){var d=b.data(k,"allValues");var f=d?d.indexOf(e):-1;if(f>-1){l=b(c.find(".om-combo-list-row").get(f)).addClass("om-state-hover")}}var j=c.parent(),i=k.parent();if(!m.listAutoWidth){j.width(i.outerWidth())}else{j.width(c.show().outerWidth());c.hide()}var g=i.offset();j.css({left:g.left,top:g.top+i.outerHeight()});c.show();if(l){c.scrollTop(b(l).offset().top-c.offset().top)}},_toggleLoading:function(d,c){if(!this.options.disabled){if(c=="add"){b.data(d,"expandTrigger").removeClass("om-icon-carat-1-s").addClass("om-loading")}else{if(c=="remove"){b.data(d,"expandTrigger").removeClass("om-loading").addClass("om-icon-carat-1-s")}}}},_ajaxLoad:function(f,e){var c=this;var d=this.options;b.ajax({url:e,method:"POST",dataType:"json",success:function(g,i){c.dataHasLoaded=true;var h=d.onSuccess;if(h&&h(g,i)===false){d.dataSource=g;return}c._loadData(f,g);c._toggleLoading(f,"remove")},error:function(g,i,h){c.dataHasLoaded=true;if(d.onError){c._toggleLoading(f,"remove");d.onError(g,i,h)}else{c._toggleLoading(f,"remove");throw new Error('An error occurred while load records from URL "'+e+'",the error message is:'+h.message)}}})},_loadData:function(k,h){var f=b.data(k,"combo");var o=f.options;o.dataSource=h;f.dataHasLoaded=true;var g=o.inputField;var i=[];if(typeof g==="string"){b(h).each(function(){i.push(this[g])})}else{b(h).each(function(p){i.push(g(this,p))})}b.data(k,"allInputText",i);var n=o.valueField;var d=[];if(typeof n==="string"){b(h).each(function(){d.push(this[n])})}else{b(h).each(function(p){d.push(n(this,p))})}b.data(k,"allValues",d);var c=b.data(k,"dropList").empty();if(o.listProvider){var l=o.listProvider(c,h);if(l){l.each(function(){b(this).addClass("om-combo-list-row")})}}else{var j=o.optionField;var e="";var m=this;if(typeof j==="string"){b(h).each(function(p){e+=m._wrapText(this[o.optionField])})}else{b(h).each(function(p){e+=m._wrapText(o.optionField(this,p))})}if(e){b(e).appendTo(c);c.show().css("height","auto");if(o.listMaxHeight!="auto"&&c.height()>o.listMaxHeight){c.height(o.listMaxHeight).css("overflow-y","auto")}c.hide();if(k.parent().hasClass("om-state-hover")){m._showDropList(m.element)}}}if(o.value){this._setValue(k,o.value)}this._bindEventsToList(k)},_bindEventsToList:function(e){var d=this._getAllOptionsBeforeFiltered(e);var c=this;d.hover(function(){d.removeClass("om-state-hover");b(this).addClass("om-state-hover")},function(){b(this).removeClass("om-state-hover")}).mousedown(function(){c._backfill()})},_wrapText:function(c){return'<div class="om-combo-list-row">'+c+"</div>"},_setValue:function(j,i){var h=b(j);var e=true;var c=h.attr(a);if(i==c){e=false}var d=b.data(j,"allValues");var g=d.indexOf(i);b.data(j,"dropList").find(".om-combo-list-row").removeClass("om-state-hover");if(g>-1){var f=b.data(j,"allInputText")[g];h.attr(a,i).val(f)}else{h.attr(a,"").val("");i=""}var k=b.data(j,"combo").options;k.value=i;if(k.onValueChange&&e){k.onValueChange(j,i,c)}this._refeshEmptyText(k.emptyText,h)},_selectPrev:function(){var g=this.element;var d=b.data(g,"dropList");var e=this._getAllOptionsAfterFiltered(g);var h=e.index(d.find(".om-state-hover"));var c=b(e[h]);if(h===0){h=e.length}else{if(h==-1){h=e.length}}var f=b(e[h-1]);this._highLisghtAndScrollTo(c,f,d)},_selectNext:function(){var g=this.element;var e=b.data(g,"dropList");if(e.css("display")=="none"){this._showDropList(g);return}var f=this._getAllOptionsAfterFiltered(g);var h=f.index(e.find(".om-state-hover"));var d=b(f[h]);if(h==f.length-1){h=-1}var c=b(f[h+1]);this._highLisghtAndScrollTo(d,c,e)},_highLisghtAndScrollTo:function(d,e,c){d.removeClass("om-state-hover");e.addClass("om-state-hover");if(e.position().top<=0){c.scrollTop(c.scrollTop()+e.position().top)}else{if(e.position().top+e.outerHeight()>c.height()){c.scrollTop(c.scrollTop()+e.position().top+e.outerHeight()-c.height())}}},_backfill:function(){var e=this.element;var c=b.data(e,"dropList");if(c.css("display")=="none"){return}var f=c.find(".om-state-hover").index();if(f>-1){var d=b.data(e,"allValues")[f];this._setValue(e,d)}c.hide()},_getAllOptionsBeforeFiltered:function(d){var c=b.data(d,"dropList");return c.find(".om-combo-list-row")},_getAllOptionsAfterFiltered:function(d){var c=b.data(d,"dropList");return c.find(".om-combo-list-row").not(c.find(".om-helper-hidden"))},_doFilter:function(){var i=this.element;var l=b.data(i,"combo").options;var e=l.dataSource;var d=l.filterStrategy;var j=i.val();var g=this._getAllOptionsBeforeFiltered(i);var h=b.data(i,"allInputText");var k=this;var f=false;b(e).each(function(m){if(k._filetrPass(d,j,e[m],h[m])){b(g.get(m)).removeClass("om-helper-hidden");f=true}else{b(g.get(m)).addClass("om-helper-hidden")}});var c=b.data(i,"dropList").css("height","auto");if(l.listMaxHeight!="auto"&&c.height()>l.listMaxHeight){c.height(l.listMaxHeight).css("overflow-y","auto")}if(!f){c.hide()}},_filetrPass:function(e,g,c,f){if(g===""){return true}if(typeof e==="function"){return e(g,c)}else{if(e==="first"){return f.indexOf(g)===0}else{if(e==="anywhere"){return f.indexOf(g)>-1}else{if(e==="last"){var d=f.lastIndexOf(g);return d>-1&&d+g.length==f.length}else{return false}}}}},_refeshEmptyText:function(c,d){if(!c){return}if(d.val()===""){d.val(c).addClass("om-empty-text")}else{if(d.val()===c){d.val("")}d.removeClass("om-empty-text")}}})})(jQuery);