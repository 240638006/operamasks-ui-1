(function(c){var a="om-suggestion-list-row";var b="om-state-hover";c.widget("om.omSuggestion",{options:{disabled:false,readOnly:false,minChars:1,delay:500,cacheSize:10,method:"GET",listMaxHeight:300,queryName:"key",crossDomain:false,onBeforeSuggest:function(d){},onSuggesting:function(d){},onSuccess:function(d,e){},onError:function(e,f,d){},onSelect:function(e,f,d){}},_create:function(){var d=this.options;var f=this.element;f.addClass("om-suggestion om-widget om-state-default om-state-nobg");if(d.minChars<0){d.minChars=0}if(d.cacheSize<0){d.cacheSize=0}if(d.delay<0){d.delay=0}var e=c(c('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css("position","absolute").appendTo(document.body).children()[0]).hide();c.data(f,"dropList",e)},_init:function(){var e=this.options;var g=this.element.attr("autocomplete","off");var f=c.data(g,"dropList");if(e.disabled){this.disable()}else{this.enable()}if(e.readOnly){g.attr("readonly","readonly")}else{g.removeAttr("readonly")}var d=this;g.focus(function(){c(this).addClass("om-state-focus")}).blur(function(){c(this).removeClass("om-state-focus")}).bind("mouseenter mouseout",function(){c(this).toggleClass("om-state-hover")}).keydown(function(h){if(h.keyCode==9){f.hide()}}).keyup(function(j){var i=j.keyCode;switch(i){case 40:if(f.css("display")!=="none"){d._selectNext()}else{if(f.find("."+a).size()>0){f.show()}}break;case 38:if(f.css("display")!=="none"){d._selectPrev()}else{if(f.find("."+a).size()>0){f.show()}}break;case 13:f.hide();return false;case 27:f.hide();break;case 9:break;default:if(e.disabled||e.readOnly){return false}if(e.delay>0){var h=c.data(g,"delayTimer");if(h){clearTimeout(h)}h=setTimeout(function(){d._suggest()},e.delay);c.data(g,"delayTimer",h)}else{d._suggest()}}}).mousedown(function(h){h.stopPropagation()});f.mousedown(function(h){h.stopPropagation()});c(document).bind("mousedown.omSuggestion",function(){f.hide()})},clearCache:function(){c.removeData(this.element,"cache")},showMessage:function(f){var g=this.element;var e=c.data(g,"dropList").empty().css("height","auto");c("<div>"+f+"<div>").appendTo(e);e.parent().css("left",g.offset().left).css("top",g.offset().top+g.outerHeight());var h=this.options.listWidth;if(!h){e.parent().width(g.outerWidth())}else{if(h!=="auto"){e.parent().width(h)}}e.show();var d=this.options.listMaxHeight;if(d!=="auto"){if(e.height()>d){e.height(d).css("overflow","auto")}}return this},disable:function(){return this.element.attr("disabled","disabled").addClass("om-state-disabled")},enable:function(){return this.element.removeAttr("disabled").removeClass("om-state-disabled")},setData:function(e){var d=this.options;if(e){d.dataSource=e}if(d.cacheSize>0){this.clearCache()}},getData:function(){var d=c.data(this.element,"records");return d||null},_clear:function(){var e=this.element.val("");var d=c.data(e,"dropList");return d.find("."+a).removeClass(b)},_selectNext:function(){var g=this.element;var e=c.data(g,"dropList");var d=e.find("."+b).index();var f=this._clear();d+=1;if(d>=f.size()){d=0}this._scrollToAndSelect(f,d,e)},_selectPrev:function(){var g=this.element;var e=c.data(g,"dropList");var d=e.find("."+b).index();var f=this._clear();d-=1;if(d<0){d=f.size()-1}this._scrollToAndSelect(f,d,e)},_scrollToAndSelect:function(g,d,f){var h=c(g.get(d)).addClass(b);var e=h.position().top;if(e<=0){f.scrollTop(f.scrollTop()+e)}else{var i=e+h.outerHeight()-f.height();if(i>0){f.scrollTop(f.scrollTop()+i)}}this._select(d)},_select:function(f){var h=this.element;var d=c.data(h,"records");var g,i;if(d.valueField){g=d.data[f];i=g[d.valueField]}else{g=d[f];i=g}h.val(i);c.data(h,"lastStr",i);var e=this.options.onSelect;if(e){e(g,i,f)}},_suggest:function(){var g=this.element;var i=g.val();var h=c.data(g,"lastStr");if(h&&h===i){return}c.data(g,"lastStr",i);var l=this.options;var d=c.data(g,"cache");if(i.length>0&&i.length>=l.minChars){if(d){var e=d[i];if(e){c.data(g,"records",e);this._buildDropList(e,i);return}}if(l.onBeforeSuggest){if(l.onBeforeSuggest(i)===false){c.data(g,"dropList").empty().hide();return}}var k=this;var j={url:l.dataSource,type:l.method,dataType:l.crossDomain?"jsonp":"json",data:{},success:function(q,s){var r=l.onSuccess;if(r&&r(q,s)===false){return}var o=l.preProcess;if(o){q=o(i,q)}if(typeof q==="undefined"){q=[]}if(l.cacheSize>0){var n=c.data(g,"cache")||{___keys:[]};var p=n.___keys;if(p.length==l.cacheSize){var m=p[0];n.___keys=p.slice(1);n[m]=undefined}n[i]=q;n.___keys.push(i);c.data(g,"cache",n)}c.data(g,"records",q);k._buildDropList(q,i)},error:function(n,p,o){var m=l.onError;if(m){m(n,p,o)}}};j.data[l.queryName]=i;c.ajax(j);var f=l.onSuggesting;if(f){f(i)}}else{c.data(g,"dropList").empty().hide()}},_buildDropList:function(e,k){var j=this.element;var d=c.data(j,"dropList").empty().css("height","auto");var g=e.valueField?false:true;var l=this.options.clientFormatter;var m=this;if(g){if(l){c(e).each(function(n){m._addRow(l(this,n),d)})}else{c(e).each(function(n){m._addRow(this,d)})}}else{if(l){c(e.data).each(function(n){m._addRow(l(this,n),d)})}}var i=d.find("."+a);if(i.size()>0){d.parent().css("left",parseInt(j.offset().left)).css("top",j.offset().top+j.outerHeight());var h=this.options.listWidth;if(!h){d.parent().width(j.outerWidth())}else{if(h!=="auto"){d.parent().width(h)}}i.mouseover(function(){i.removeClass(b);c(this).addClass(b)}).mousedown(function(){var n=d.find("."+b).index();m._select(n);d.hide()});d.show();var f=this.options.listMaxHeight;if(f!=="auto"){if(d.height()>f){d.height(f).css("overflow","auto")}}d.scrollTop(0)}},_addRow:function(e,d){c('<div class="'+a+'">'+e+"</div>").appendTo(d)}})})(jQuery);